<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!--
  Copyright (c) 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
  -->
  <head>
    <title>Quake</title>
    <link href="quake.css" rel="stylesheet" type="text/css"/>

    <script type="text/javascript">
      var Quake = null;
      var progress_bar = null;
      var kBytesExpected = 19000000; //inexact

      var bytes_so_far = 0;
      var times_called = 0;
      function HandleMessage(message_event) {
        ++times_called;
        // Currently, the only messages we receive are integers telling us how
        // many bytes were just received. Add them to the total.
        bytes_so_far += message_event.data;
        progress_bar.fillStyle = "rgb(200, 200, 200)";
        var percent = (bytes_so_far / kBytesExpected);
        progress_bar.fillRect(0, 0, percent*800, 20);
        progress_bar.fillStyle = "#A9A9A9"; //TODO: hack, copied from css
        progress_bar.fillRect(percent*800, 0, 800, 20);
        progress_bar.fillStyle = "black";
        progress_bar.textAlign = "center";
        progress_bar.textBaseline = "middle";
        //progress_bar.font = 'sans-serif';
        //var text = bytes_so_far.toString() + "/" + kBytesExpected.toString();
        //var metrics = progress_bar.measureText(text);
        progress_bar.fillText(bytes_so_far.toString() + "/" +
                              kBytesExpected.toString(), 400, 10);
        //progress_bar.fillText(text, 400, 10);
        if (bytes_so_far >= kBytesExpected) {
          progress_bar.fillStyle = "rgba(0,0,0)";
          progress_bar.fillRect(0, 0, 800, 20);
          console.log("Progress updated " + times_called + " times.");
        }
      } 

      function moduleDidLoad() {
        Quake = document.getElementById('Quake');
        progress_bar = document.getElementById('progress_bar').getContext('2d');
        Quake.addEventListener('message', HandleMessage, false);
      }
    </script>
  </head>
  <body id="bodyId" onunload="pageDidUnload()">
    <h1>Quake</h1>
    This is a Native Client port of <a href="http://idsoftware.com/games/quake/quake/">Quake</a> by <a href="http://idsoftware.com">id Software</a>.

<p><strong>Source code:</strong><br>
<ul>
  <li><a target="_blank" href="http://www.libsdl.org/projects/quake/src/q1source.zip">Original Quake</a></li>
  <li><a target="_blank" href="http://www.libsdl.org/projects/quake/">SDL Quake</a></li>
  <li><a target="_blank" href="http://github.com/eugenis/sdl-nacl">SDL NaCl</a></li>
  <li><a target="_blank" href="http://github.com/davemichael/NaCl-Quake">NaCl Quake</a></li>
</ul>
  <div id="listener">
    <script type="text/javascript">
      document.getElementById('listener')
          .addEventListener('load', moduleDidLoad, true);
    </script>
    <!-- Load the published .nexe.  This includes the 'nacl' attribute which
    shows how to load multi-architecture modules.  Each entry in the "nexes"
    object in the .nmf manifest file is a key-value pair: the key is the
    runtime ('x86-32', 'x86-64', etc.); the value is a URL for the desired NaCl
    module. -->

    <embed name="nacl_module"
           id="Quake"
           width=800 height=600
           src="quake.nmf"
           type="application/x-nacl"/>
  </div>
   <canvas id="progress_bar"
    width="798" height="20">
    This text is displayed if your browser does not support HTML5 Canvas.
   </canvas>
  <br />
  </body>
</HTML>
